name: Release Azaras
on:
  workflow_dispatch:

  workflow_call:
    inputs:
      ECR_REPOSITORY: 
        required: false
        default: ${{ jobs.gen-tag.steps.set-image-tag.outputs.image }}
        # jobs.image-tag.steps.set-image-tag.outputs.tag
        type: string
    secrets:
      ECR_REGISTRY: 
        required: true
      ECR_REPOSITORY: 
        required: true
      SEGREDO: 
        required: true


jobs:
  cancel-previous:
      name: Cancel Previous Runs
      runs-on: ubuntu-latest
      steps:
        - name: Cancel Previous Runs
          uses: styfle/cancel-workflow-action@0.9.0
          with:
            access_token: ${{ github.token }}
  gen-tag:
    name: Gen tag
    outputs:
      image: ${{ steps.set-image-tag.outputs.image }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Tagged image setup
      id: set-image-tag
      env:
        ECR_REGISTRY: ${{ secrets.SEGREDO }}
        ECR_REPOSITORY: superrepo
      run: |
        # set image tag
        echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:${GITHUB_REF##*/}"
    
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    needs: gen-tag

    steps:
    - name: Out
      id: outtage
      run: |
        echo "set image deployment/api api=${{ needs.gen-tag.outputs.image }} -n app-app"
        echo "set image deployment/api api=$ECR_REGISTRY/$ECR_REPOSITORY:${GITHUB_REF##*/} -n app-app"
        echo "Segredo: ${{ secrets.SEGREDO }}"
    